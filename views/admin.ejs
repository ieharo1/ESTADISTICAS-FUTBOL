<%- include('partials/header', { title }) %>

<div class="page-header">
  <div class="d-flex flex-column flex-lg-row gap-3 align-items-lg-center justify-content-between">
    <div>
      <h1>Administración de Usuarios</h1>
      <p class="mb-0">Gestiona los usuarios del sistema</p>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
      <i class="fas fa-user-plus me-2"></i> Agregar Usuario
    </button>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0"><i class="fas fa-users me-2"></i> Lista de Usuarios</h5>
    <input type="text" class="form-control w-25" placeholder="Buscar usuario..." id="searchUser" onkeyup="searchUsers()">
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="usersTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Avatar</th>
            <th>Nombre</th>
            <th>Email</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Último Login</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <tr><td colspan="8" class="text-center py-4">Cargando usuarios...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i> Agregar Nuevo Usuario</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addUserForm" onsubmit="createUser(event)">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nombre completo</label>
            <input type="text" class="form-control" name="name" required placeholder="Juan Pérez">
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="email" required placeholder="juan@ejemplo.com">
          </div>
          <div class="mb-3">
            <label class="form-label">Contraseña</label>
            <input type="password" class="form-control" name="password" required placeholder="Mínimo 6 caracteres" minlength="6">
          </div>
          <div class="mb-3">
            <label class="form-label">Rol</label>
            <select class="form-select" name="role">
              <option value="user">Usuario</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear Usuario</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-edit me-2"></i> Editar Usuario</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editUserForm" onsubmit="updateUser(event)">
        <div class="modal-body">
          <input type="hidden" name="id" id="editUserId">
          <div class="mb-3">
            <label class="form-label">Nombre completo</label>
            <input type="text" class="form-control" name="name" id="editName" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="email" id="editEmail" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Nueva Contraseña (dejar vacío para mantener)</label>
            <input type="password" class="form-control" name="password" placeholder="Nueva contraseña">
          </div>
          <div class="mb-3">
            <label class="form-label">Rol</label>
            <select class="form-select" name="role" id="editRole">
              <option value="user">Usuario</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="isActive" id="editIsActive">
              <label class="form-check-label" for="editIsActive">Usuario activo</label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let users = [];

function loadUsers() {
  fetch('/api/admin/users')
    .then(res => res.json())
    .then(data => {
      users = data;
      renderUsers(users);
    })
    .catch(err => {
      document.getElementById('usersTableBody').innerHTML = 
        '<tr><td colspan="8" class="text-center py-4 text-danger">Error al cargar usuarios</td></tr>';
    });
}

function renderUsers(usersList) {
  const tbody = document.getElementById('usersTableBody');
  if (!usersList || usersList.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No hay usuarios registrados</td></tr>';
    return;
  }
  
  tbody.innerHTML = usersList.map((user, index) => `
    <tr>
      <td>${index + 1}</td>
      <td>
        <div class="user-avatar-sm">
          ${user.avatar ? `<img src="${user.avatar}" alt="${user.name}">` : `<i class="fas fa-user"></i>`}
        </div>
      </td>
      <td>${user.name}</td>
      <td>${user.email}</td>
      <td>
        <span class="badge ${user.role === 'admin' ? 'bg-warning' : 'bg-primary'}">
          ${user.role === 'admin' ? 'Admin' : 'Usuario'}
        </span>
      </td>
      <td>
        <span class="badge ${user.isActive ? 'bg-success' : 'bg-danger'}">
          ${user.isActive ? 'Activo' : 'Inactivo'}
        </span>
      </td>
      <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Nunca'}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser('${user._id}')">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user._id}')">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    </tr>
  `).join('');
}

function searchUsers() {
  const search = document.getElementById('searchUser').value.toLowerCase();
  const filtered = users.filter(u => 
    u.name.toLowerCase().includes(search) || 
    u.email.toLowerCase().includes(search)
  );
  renderUsers(filtered);
}

function createUser(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);
  
  fetch('/api/admin/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(data => {
    if (data.message || data.error) {
      alert(data.message || data.error);
    } else {
      alert('Usuario creado exitosamente');
      e.target.reset();
      bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
      loadUsers();
    }
  })
  .catch(err => alert('Error al crear usuario'));
}

function editUser(id) {
  const user = users.find(u => u._id === id);
  if (!user) return;
  
  document.getElementById('editUserId').value = user._id;
  document.getElementById('editName').value = user.name;
  document.getElementById('editEmail').value = user.email;
  document.getElementById('editRole').value = user.role;
  document.getElementById('editIsActive').checked = user.isActive;
  
  new bootstrap.Modal(document.getElementById('editUserModal')).show();
}

function updateUser(e) {
  e.preventDefault();
  const id = document.getElementById('editUserId').value;
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);
  
  if (!data.password) delete data.password;
  data.isActive = data.isActive === 'on';
  
  fetch(`/api/admin/users/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(data => {
    alert('Usuario actualizado');
    bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
    loadUsers();
  })
  .catch(err => alert('Error al actualizar usuario'));
}

function deleteUser(id) {
  if (!confirm('¿Estás seguro de eliminar este usuario?')) return;
  
  fetch(`/api/admin/users/${id}`, {
    method: 'DELETE'
  })
  .then(res => res.json())
  .then(data => {
    alert('Usuario eliminado');
    loadUsers();
  })
  .catch(err => alert('Error al eliminar usuario'));
}

loadUsers();
</script>

<style>
.user-avatar-sm {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--gradient-primary);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 0.9rem;
  overflow: hidden;
}
.user-avatar-sm img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
</style>

<%- include('partials/footer') %>
